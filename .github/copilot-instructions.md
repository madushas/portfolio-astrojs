# Copilot / AI-agent instructions for this repository âœ…

Short summary

- This is an Astro 5 site (output: server) using Svelte for interactive UI, Tailwind CSS for styling, and Sanity.io as the CMS. The site is deployed with the Cloudflare adapter (Cloudflare Pages / Wrangler).

Important scripts & workflows (use pnpm)

- Development: `pnpm dev` (runs `astro dev`).
- Build (production): `pnpm build` (uses Cloudflare adapter by default).
- Local production build (Node adapter for local testing): `pnpm build:local` (uses `astro.config.local.mjs`).
- Preview production build: `pnpm preview`.
- Linting: `pnpm lint` (uses Biome). `pnpm lint:fix` to auto-fix.
- Type/health checks: `pnpm check` (astro check).

Key architecture & conventions

- Big picture: Astro renders the site using Svelte components. Content comes from Sanity (GROQ queries). The built output is prepared for Cloudflare (assets are bundled into `dist` and referenced in `wrangler.jsonc`).

- Sanity usage:
  - Centralized queries live in: `src/lib/sanity/queries.ts` (use those rather than copying queries all over).
  - Use the lazy client wrapper in `src/lib/sanity/lib/client.ts`: call `client.fetch(query, params)` and respect `isSanityConfigured()` guard so builds don't crash when env vars are missing.
  - Image helpers are in `src/lib/sanity/lib/image.ts` and the site uses `src/components/shared/SanityImage.astro` for rendering Sanity images. `astro.config*.mjs` already adds `cdn.sanity.io` to allowed image domains.

- Environment variables:
  - Copy `.env.example` -> `.env` in dev. Public runtime keys are `PUBLIC_*` and accessed via `import.meta.env.PUBLIC_*` and wrappers in `src/lib/env.ts` (e.g. `WEB3FORM_ACCESS_KEY`, `POSTHOG_KEY`).
  - The contact form (`src/components/Home/Contact.svelte`) posts to Web3Forms and requires `PUBLIC_WEB3FORM_ACCESS_KEY`.
  - `worker-configuration.d.ts` is generated by `wrangler types` and reflects runtime env expectations for Cloudflare.

- Cloudflare / deployment notes:
  - Main adapter config: `astro.config.mjs`. Important details are commented there (session driver is set to `memory` to avoid Cloudflare-KV session imports during local builds).
  - For a local production build that avoids `cloudflare:` protocol import problems, use `pnpm build:local` which uses `astro.config.local.mjs` with Node adapter.
  - `wrangler.jsonc` contains the `assets` binding (`./dist`) and compatibility flagsâ€”use `wrangler` to publish when needed.

Project-specific patterns to follow

- Prefer importing queries from `src/lib/sanity/queries.ts` and using `client.fetch(...)` instead of creating ad-hoc clients.
- Components are organized by page (e.g. `src/components/Home/*`) and shared primitives live in `src/components/shared` or `src/components/ui`.
- Styling relies on Tailwind v4 and utility classes throughout. Avoid introducing new global CSS unless necessary; update `src/styles/global.css` if you do.
- Use `src/lib/utils.ts` helpers (e.g., `cn`) when available to keep code consistent.

Small, concrete examples

- Fetch projects (server-side in an Astro page):

  ```ts
  import { GetAllProjects } from '../lib/sanity/queries';
  import { client } from '../lib/sanity/lib/client';

  const projects = await client.fetch(GetAllProjects);
  ```

- Use the Web3Forms key in the Contact component:

  ```svelte
  import { WEB3FORM_ACCESS_KEY } from '../../lib/env';
  // used as form field 'access_key'
  ```

Troubleshooting tips & gotchas

- If a local build fails with errors referencing `cloudflare:` imports, use `pnpm build:local` or set `session.driver: 'memory'` (see `astro.config.mjs` comments).
- Sharp is a native dependencyâ€”on Linux you may need libvips installed for `sharp` to compile correctly.
- Sanity project ID is permissive at build-time (fallbacks exist), but some pages expect Sanity content to exist; use `isSanityConfigured()` to build without secrets.

Where to edit content / schemas

- Sanity schemas are in `src/lib/sanity/schema.ts` and `src/lib/sanity/schemaTypes/` â€” the canonical CMS is Sanity (edit content in your Sanity Studio or via the schema files).

If unsure, ask about:

- Which pages are failing to build or where content is missing.
- Whether you need a local build that mirrors Cloudflare behavior (we can show how to use `pnpm build:local`).

Thanks â€” let me know if you want this shortened, expanded (e.g., full troubleshooting checklist), or if you'd like automated checks (GH Actions) added to enforce any of these conventions. ðŸ™Œ
