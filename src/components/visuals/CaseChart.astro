---
interface Props {
	class?: string;
}

const { class: className } = Astro.props;

// Chart geometry
const W = 640;
const H = 320;
const PAD = { t: 24, r: 20, b: 32, l: 40 };
const innerW = W - PAD.l - PAD.r;
const innerH = H - PAD.t - PAD.b;

// X labels (6 months) and sample data
const labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
const data = [14, 12, 11, 7, 5, 4];

// Scales
const x = (i: number) => PAD.l + (i * innerW) / (labels.length - 1);
const maxY = Math.max(...data);
const minY = Math.min(...data);
const y = (v: number) => PAD.t + innerH - ((v - minY) / (maxY - minY)) * innerH;

// Path
const d = data.map((v, i) => `${i === 0 ? 'M' : 'L'}${x(i)},${y(v)}`).join(' ');

const rolloutX = x(2);
---

<svg
  viewBox={`0 0 ${W} ${H}`}
  width="100%"
  height="100%"
  class={className}
  role="img"
  aria-label="Incidents trending down across six months with a change introduced in March"
>
  <defs>
    <style>
      .chart-grid { stroke: currentColor; opacity: .18; }
      .chart-muted { stroke: currentColor; opacity: .35; }
      .chart-label { fill: currentColor; font-size: 12px; font-family: "IBM Plex Sans", ui-sans-serif, system-ui; }
    </style>
  </defs>

  <!-- Background -->
  <rect x="0" y="0" width={W} height={H} fill="none" />

  <!-- Gridlines -->
  {Array.from({ length: 5 }).map((_, i) => {
    const yy = PAD.t + (i * innerH) / 4;
    return <line x1={PAD.l} x2={W - PAD.r} y1={yy} y2={yy} class="chart-grid" />;
  })}

  <!-- Axes -->
  <line x1={PAD.l} x2={W - PAD.r} y1={H - PAD.b} y2={H - PAD.b} class="chart-muted" />
  <line x1={PAD.l} x2={PAD.l} y1={PAD.t} y2={H - PAD.b} class="chart-muted" />

  <!-- X labels -->
  {labels.map((lbl, i) => (
    <text x={x(i)} y={H - 10} text-anchor="middle" class="chart-label">
      {lbl}
    </text>
  ))}

  <!-- Y label -->
  <text x={PAD.l - 12} y={PAD.t - 8} text-anchor="end" class="chart-label">
    Incidents/week
  </text>

  <!-- Rollout marker -->
  <line x1={rolloutX} x2={rolloutX} y1={PAD.t} y2={H - PAD.b} stroke-dasharray="4 4" class="chart-muted" />
  <text x={rolloutX + 6} y={PAD.t + 12} class="chart-label">Backpressure rollout</text>

  <!-- Micro-annotations -->
  <g class="text-foreground">
    <line x1={rolloutX} x2={rolloutX + 18} y1={y(data[2])} y2={y(data[2]) - 24} class="chart-muted" />
    <text x={rolloutX + 22} y={y(data[2]) - 26} class="chart-label">Retry budget</text>
    
    <line x1={x(3)} x2={x(3) - 18} y1={y(data[3])} y2={y(data[3]) - 20} class="chart-muted" />
    <text x={x(3) - 22} y={y(data[3]) - 22} text-anchor="end" class="chart-label">Queue enabled</text>
    
    <line x1={x(4)} x2={x(4) + 18} y1={y(data[4])} y2={y(data[4]) + 20} class="chart-muted" />
    <text x={x(4) + 22} y={y(data[4]) + 22} class="chart-label">Timeout tuned</text>
  </g>

  <!-- Data line -->
  <g class="text-primary">
    <path d={d} fill="none" stroke="currentColor" stroke-width="2" />
    {data.map((v, i) => (
      <circle cx={x(i)} cy={y(v)} r="3" fill="currentColor" />
    ))}
  </g>
</svg>
